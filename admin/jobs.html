<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Jobs Admin</title>
<meta name="robots" content="noindex,nofollow" />
<style>
:root {
  --ink: #e2e8f0;
  --muted: #94a3b8;
  --line: #334155;
  --bg: #0f172a;
  --accent: #38bdf8;
}
body {
  margin: 24px;
  font: 15px system-ui, -apple-system, "Segoe UI", Roboto;
  color: var(--ink);
  background: var(--bg);
}
h1 { margin: 0 0 8px; font-size: 26px; color: #f1f5f9; }
.note { color: var(--muted); font-size: 13px; margin-bottom: 16px; }
.card {
  border: 1px solid var(--line);
  border-radius: 12px;
  padding: 14px;
  margin: 12px 0;
  background: #1e293b;
  box-shadow: 0 2px 8px rgba(0,0,0,0.4);
}
.row {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  align-items: end;
}
label { font-size: 12px; color: var(--muted); }
input, select, textarea {
  font: inherit;
  padding: 10px;
  border: 1px solid var(--line);
  border-radius: 10px;
  background: #0f172a;
  color: var(--ink);
}
input[type="text"] { min-width: 220px; }
button {
  padding: 10px 14px;
  border: 0;
  border-radius: 10px;
  background: var(--accent);
  color: #041923;
  font-weight: 700;
  cursor: pointer;
  transition: background 0.2s;
}
button:hover { background: #7dd3fc; }
table { width: 100%; border-collapse: collapse; font-size: 14px; }
th, td { border-top: 1px solid var(--line); padding: 10px; vertical-align: top; }
a { color: #38bdf8; text-decoration: none; }
a:hover { text-decoration: underline; }
.right { text-align: right; }
.mono {
  font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
  color: #bae6fd;
}
.pill {
  display: inline-block;
  padding: .2rem .5rem;
  border: 1px solid var(--line);
  border-radius: 999px;
  margin-right: 6px;
  font-size: 12px;
  color: var(--muted);
  background: #1e293b;
}
</style>
</head>
<body>
<h1>Jobs Admin</h1>
<p class="note">Private page (not linked). Use it to build LinkedIn searches and track applications. Data is stored locally in your browser.</p>
<p class="note">If debugging, drag this too: <a id="bmPeek" class="mono" href="#">Peek capture</a></p>

<!-- 1) LinkedIn search builder -->
<div class="card">
  <h3 style="margin:0 0 6px">LinkedIn Search Builder</h3>
  <div class="row">
    <div><label>Keywords</label><br/><input id="kw" type="text" placeholder="e.g., Data Analyst Python SQL"/></div>
    <div><label>Location</label><br/><input id="loc" type="text" placeholder="Remote or City, State"/></div>
    <div><label>Date posted</label><br/>
      <select id="date">
        <option value="">Anytime</option>
        <option value="r86400">Past 24 hours</option>
        <option value="r604800">Past week</option>
        <option value="r2592000">Past month</option>
      </select>
    </div>
    <div><label>Experience</label><br/>
      <select id="exp">
        <option value="">Any</option>
        <option value="2">Entry level</option>
        <option value="3">Associate</option>
        <option value="4">Mid-Senior</option>
        <option value="5">Director</option>
      </select>
    </div>
    <div><label>On-site / Remote</label><br/>
      <select id="onsite">
        <option value="">Any</option>
        <option value="1">On-site</option>
        <option value="2">Hybrid</option>
        <option value="3">Remote</option>
      </select>
    </div>
    <div><button id="openLI">Open LinkedIn Search</button></div>
  </div>
  <p class="note">Tip: LinkedIn URL params change sometimes; this builder uses common filters and opens a new tab with results sorted by recent.</p>
</div>

<!-- 2) Tracker quick add -->
<div class="card">
  <h3 style="margin:0 0 6px">Quick Add to Tracker</h3>
  <div class="row">
    <div><label>Title</label><br/><input id="tTitle" type="text" placeholder="Job title"></div>
    <div><label>Company</label><br/><input id="tCompany" type="text" placeholder="Company"></div>

    <!-- Dropdown Location -->
    <div>
      <label>Location</label><br/>
      <select id="tLocation">
        <option value="">— Select —</option>
        <option>Remote</option>
        <option>Hybrid</option>
        <option>On-site</option>
      </select>
    </div>

    <div style="flex:1 0 100%"><label>Job Link</label><br/><input id="tLink" type="text" placeholder="https://..."></div>
    <div>
      <label>Status</label><br/>
      <select id="tStatus">
        <option>Saved</option><option>Applied</option><option>Interview</option>
        <option>Offer</option><option>Rejected</option>
      </select>
    </div>
    <div style="flex:1 0 100%"><label>Notes</label><br/><textarea id="tNotes" rows="2" placeholder="Quick notes…"></textarea></div>
    <div><button id="addRow">Add</button></div>
    <div><button id="exportCsv" style="background:#10b981">Export CSV</button></div>
    <div><button id="clearAll" style="background:#ef4444;color:#fff">Clear (local)</button></div>
  </div>
</div>

<!-- 3) Table -->
<div class="card">
  <div><span class="pill">Saved</span><span class="pill">Applied</span><span class="pill">Interview</span>
  <span class="pill">Offer</span><span class="pill">Rejected</span></div>
  <table id="tab">
    <thead><tr><th>Title</th><th>Company</th><th>Location</th><th>Link</th><th>Status</th><th>Notes</th><th class="right">—</th></tr></thead>
    <tbody></tbody>
  </table>
</div>

<!-- 4) Bookmarklet installer -->
<div class="card">
  <h3 style="margin:0 0 6px">Bookmarklet: “Save to Tracker”</h3>
  <p class="note">Drag this to your bookmarks bar: <a id="bm" class="mono" href="#">Save to Tracker</a></p>
  <p class="note">How it works: on a LinkedIn job page, click the bookmarklet. It reads title/company and opens this page with fields prefilled (then shows “Loading…” and closes the capture tab).</p>
  <p><button id="copyBm" style="background:#fbbf24;color:#041923">Copy Bookmarklet Code</button>
  <span class="note" id="copyNote" style="margin-left:10px"></span></p>
</div>

<script>
/* ========== LinkedIn Search Builder ========== */
document.getElementById('openLI').onclick = () => {
  const q = encodeURIComponent(document.getElementById('kw').value.trim());
  const loc = encodeURIComponent(document.getElementById('loc').value.trim());
  const f_TPR = document.getElementById('date').value;
  const f_E = document.getElementById('exp').value;
  const f_WT = document.getElementById('onsite').value;
  let url = `https://www.linkedin.com/jobs/search/?keywords=${q}`;
  if (loc) url += `&location=${loc}`;
  if (f_TPR) url += `&f_TPR=${f_TPR}`;
  if (f_E) url += `&f_E=${f_E}`;
  if (f_WT) url += `&f_WT=${f_WT}`;
  url += `&sortBy=R`;
  window.open(url, '_blank');
};

/* ========== Tracker (localStorage) ========== */
const KEY = 'jobs_tracker_v1';
const $ = (id)=>document.getElementById(id);
const tbody = $('tab').querySelector('tbody');

function loadAll(){ try{ return JSON.parse(localStorage.getItem(KEY))||[]; }catch{ return []; } }
function saveAll(rows){ localStorage.setItem(KEY, JSON.stringify(rows)); }
function render(){
  const rows = loadAll();
  tbody.innerHTML = '';
  rows.forEach((r,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHtml(r.title||'')}</td>
      <td>${escapeHtml(r.company||'')}</td>
      <td>${escapeHtml(r.location||'')}</td>
      <td><a href="${/^https?:\/\//i.test(r.link||'') ? r.link : '#'}" target="_blank">open</a></td>
      <td>${escapeHtml(r.status||'Saved')}</td>
      <td>${escapeHtml(r.notes||'')}</td>
      <td class="right"><button data-i="${i}" class="del" style="background:#e5e7eb">Remove</button></td>`;
    tbody.appendChild(tr);
  });
}
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
render();

$('addRow').onclick = () => {
  const rows = loadAll();
  rows.unshift({
    title: $('tTitle').value.trim(),
    company: $('tCompany').value.trim(),
    location: $('tLocation').value, // dropdown value
    link: $('tLink').value.trim(),
    status: $('tStatus').value,
    notes: $('tNotes').value.trim(),
    addedAt: new Date().toISOString()
  });
  saveAll(rows); render();
  ['tTitle','tCompany','tLink','tNotes'].forEach(id=>$(id).value='');
  $('tLocation').value = ''; // reset dropdown
};

tbody.addEventListener('click', e=>{
  const b = e.target.closest('button.del'); if(!b)return;
  const i=+b.dataset.i; const rows=loadAll(); rows.splice(i,1); saveAll(rows); render();
});

$('exportCsv').onclick = () => {
  const rows = loadAll();
  const csv = ['Title,Company,Location,Link,Status,Notes,AddedAt']
    .concat(rows.map(r => [
      r.title, r.company, r.location, r.link, r.status, r.notes, r.addedAt
    ].map(x => `"${String(x||'').replace(/"/g,'""')}"`).join(',')))
    .join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'jobs-tracker.csv';
  a.click();
};

$('clearAll').onclick = () => {
  if (confirm('Clear all tracker data stored in this browser?')) {
    localStorage.removeItem(KEY); render();
  }
};

/* ========== Prefill via URL (from bookmarklet) ========== */
(function prefillFromQuery(){
  const p=new URLSearchParams(location.search);
  if(p.get('pf')==='1'){
    $('tTitle').value=p.get('title')||'';
    $('tCompany').value=p.get('company')||'';
    // Location deliberately not passed via bookmarklet.
    $('tLink').value=p.get('link')||'';
  }
})();

/* ========== Bookmarklet: Save to Tracker (with Loading + auto-close) ========== */
(function makeBookmarklet(){
  const adminUrl='https://nmillerit.github.io/personal-site/admin/jobs.html';

  const code = `(function(){
    const admin='${adminUrl}';
    const w=window.open('about:blank','pt_'+Date.now());
    if(!w){alert('Popup blocked');return;}
    const esc=s=>String(s).replace(/[&<>]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[m]));
    let dt=(document.title||'').trim();
    dt=dt.replace(/\\s*\\|\\s*LinkedIn.*/i,'').replace(/\\s*-\\s*LinkedIn.*/i,'');
    const parts=dt.split(/\\s*\\|\\s*|\\s*-\\s*/);
    const TITLE=(parts[0]||dt).trim();
    const COMPANY=(parts[1]||'').trim();
    const raw=(document.body&&document.body.innerText||'').slice(0,1200);

    const html='<!doctype html><meta charset=utf-8><title>Send to Tracker</title>'
      +'<body style="font:15px system-ui;padding:20px;background:#0f172a;color:#e2e8f0;">'
      +'<h2 style="color:#38bdf8;">LinkedIn Job Capture</h2>'
      +'<label>Title</label><br><input id="t" value="'+esc(TITLE)+'" style="width:100%;padding:8px;margin:4px 0;"><br>'
      +'<label>Company</label><br><input id="c" value="'+esc(COMPANY)+'" style="width:100%;padding:8px;margin:4px 0;"><br>'
      +'<a id="open" href="#" style="display:inline-block;margin:10px 10px 10px 0;padding:10px 16px;border-radius:8px;'
      +'background:#38bdf8;color:#041923;font-weight:700;text-decoration:none">Open in Jobs Admin</a>'
      +'<pre style="white-space:pre-wrap;background:#1e293b;padding:10px;border-radius:8px;max-height:40vh;overflow:auto;">'
      +esc(raw)+'</pre></body>';

    w.document.open(); w.document.write(html); w.document.close();

    function init(){
      try{
        const d=w.document, T=d.getElementById('t'), C=d.getElementById('c'), A=d.getElementById('open');
        if(!T||!C||!A){ setTimeout(init,40); return; }

        const build=()=> admin+'?pf=1&title='+encodeURIComponent(T.value||'')
                                 +'&company='+encodeURIComponent(C.value||'')
                                 +'&link='+encodeURIComponent(location.href||'');

        const update=()=>A.setAttribute('data-href',build());
        [T,C].forEach(el=>el.addEventListener('input',update));
        update();

        A.addEventListener('click',ev=>{
          ev.preventDefault();
          const href=A.getAttribute('data-href');
          window.open(href,'_blank','noopener,noreferrer');
          w.document.body.innerHTML='<div style="font:18px system-ui;color:#38bdf8;text-align:center;margin-top:40px;">Loading...</div>';
          setTimeout(()=>{ try{ w.close(); }catch(_){ } },500);
        });

        // Auto open after a short delay and show Loading..., then close the capture tab
        setTimeout(()=>{
          const href=A.getAttribute('data-href')||build();
          try{ w.open(href,'_blank','noopener,noreferrer'); }catch(_){ window.open(href,'_blank','noopener,noreferrer'); }
          w.document.body.innerHTML='<div style="font:18px system-ui;color:#38bdf8;text-align:center;margin-top:40px;">Loading...</div>';
          setTimeout(()=>{ try{ w.close(); }catch(_){ } },800);
        },1000);

      }catch(e){ setTimeout(init,40); }
    }
    if(w.document.readyState==='complete'){ init(); } else { w.onload=init; }
  })();`;

  const minified='javascript:'+code.replace(/\s+/g,' ');
  $('bm').href=minified;

  const btn=$('copyBm'); const note=$('copyNote');
  btn.onclick=async()=>{
    try{
      await navigator.clipboard.writeText(minified);
      note.textContent='✅ Copied!';
      setTimeout(()=>note.textContent='',4000);
    }catch{
      note.textContent='⚠ Copy blocked.';
    }
  };
})();

/* ========== Peek (debug helper) ========== */
(function makePeek(){
  const peekCode=`(function(){
    const t=s=>document.querySelector(s)?.innerText?.trim()||'';
    const title=t('h1, h1[data-test-id="job-title"]');
    const company=t('.topcard__org-name-link,[data-test-id="company-name"]');
    alert('Title: '+title+'\\nCompany: '+company+'\\nURL: '+(window.location&&window.location.href));
  })();`;
  document.getElementById('bmPeek').href='javascript:'+peekCode.replace(/\s+/g,' ');
})();
</script>
</body>
</html>
